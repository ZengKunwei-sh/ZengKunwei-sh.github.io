# 学习强国积分自动化
<img src="/images/2022-3-19-学习强国积分自动化/学习强国主页.png" width="700" height="260"/>
 
## 背景介绍
&emsp;“学习强国”学习平台是由中共中央宣传部主管，以习近平新时代中国特色社会主义思想和党的十九大精神为主要内容，立足全体党员、面向全社会的优质平台[^1]。
对笔者而言，“学习强国”同样是适合获取国家官方信息、了解当今时事、学习医疗健康等各类科普知识的好平台。

&emsp;部分党员对需要每日登录平台、阅读文章而获取的积分有所需求，但常常不小心遗忘或因繁忙而没有时间取得积分。

&emsp;笔者希望能通过python的selenium库实现模拟浏览器操作而自动获取平台积分的功能。

<img src="/images/2022-3-19-学习强国积分自动化/积分.png" width="500" height="250"/>

## 预期目标功能
- 模拟账户登录
- 阅读文章
- 观看视频
- 自动答题并保证正确率
- 运行结束后将结果记录在日志中
## 模拟账户登录
&emsp;学习强国的网页版需要使用手机扫描二维码登录账户。由此我们可以在手动登录账户后获取页面cookies，将cookies保存为本地json文件，使得之后都可以免去登录步骤。

<img src="/images/2022-3-19-学习强国积分自动化/登录.png" width="300" height="150"/>

### 手动登录并获取cookies
```
from selenium import webdriver
import time

browser = webdriver.Chrome()
browser.get('https://pc.xuexi.cn/points/login.html')
browser.maximize_window()                                               # 窗口最大化
browser.execute_script("var q=document.documentElement.scrollTop=1300") # 滑动滚动条至距离顶部1300的位置

time.sleep(20)                                                          # 设置等待时间，利用该时间手机扫码登录账户
```
### 将cookies存储为文本文件
```
with open('cookies.txt', 'w') as f:
    f.write(str(cookies))
```
### 读取cookies
```
with open('cookies.txt', 'r') as f:
    cookies = eval(f.read())                                # 把字符串转化为字典列表
```
### 使用cookies登录页面
```
from selenium import webdriver
    
browser = webdriver.Chrome()
browser.get('https://pc.xuexi.cn/points/my-study.html')

for cookie in cookies:                                      # 输入cookies
        browser.add_cookie(cookie) 
        
browser.get('https://pc.xuexi.cn/points/my-study.html')     # 登录学习主页
```
## 自动答题
### 进入答题页面
```
browser.get('https://pc.xuexi.cn/points/exam-index.html')
```
<img src="/images/2022-3-19-学习强国积分自动化/答题界面.png" width="600" height="250"/>

可见有三种答题类型: 每日答题，每周答题，专项答题。

### 每日答题
进入每日答题页面
```
browser.get('https://pc.xuexi.cn/points/exam-practice.html')
```
发现共有三种题目类型: 单选题，多选题，填空题。

在每道题中，单击“查看提示”可以得到答案。从这时开始我们需要观察页面源码，确认各元素的xpath。下面以单选题为例详细说明。

首先按F12进入开发者工具，单击右侧中左上角的箭号，再点击页面中元素可得知其在源码的对应位置。

<img src="/images/2022-3-19-学习强国积分自动化/单选题(1).png" width="600" height="250"/>

通过`find_element`函数可由xpath选取页面中的元素。第一个需要选取的为“单选题”，从而判断答案的个数。

```
from selenium.webdriver.common.by import By

q_header = browser.find_element(By.XPATH, '//div[@class="q-header"]').text
```

`q_header`有三种可能: 单选题、多选题、填空题。第二个需要选取的元素为“查看提示”，必须单击此处，源码中才会出现答案的内容。

<img src="/images/2022-3-19-学习强国积分自动化/单选题(2).png" width="600" height="250"/>

```
try:
    browser.find_element(By.XPATH, '//span[@class="tips ant-popover-open"]').click() # 实现单击操作
except:
    browser.find_element(By.XPATH, '//span[@class="tips"]').click()
```
使用`try...except`的原因为我在观察页面时，发现个别@class不一致。

<img src="/images/2022-3-19-学习强国积分自动化/单选题(3).png" width="600" height="250"/>

观察答案，发现我们所需要的关键字符串颜色为红，且代码中由`<font color="red">*.</font>`标注。

```
answer_elements = browser.find_elements(By.XPATH, '//div[@class="ant-popover-inner"]/div/div/div/font') # answer_elements包括了所有红字答案
```

`find_elements`与`find_element`不同之处在于返回值为节点的列表，会将所有符合条件的节点都获取到，此处为得到一个以页面中所有红色的字组成的列表。

```
answers = []

if(len(answer_elements)==0):
    answers.append('错误答案')
else:
    for element in answer_elements:
        answers.append(element.text)
```

<img src="/images/2022-3-19-学习强国积分自动化/视频题.png" width="600" height="350"/>

在填空题中，有一类比较特殊的题目为看视频填空，这类题目的“查看提示”不显示答案，因此无法作答，当获取的列表长度为0时，直接输入字符串“错误答案”。

```
if(q_header=='填空题'):
        browser.find_element(By.XPATH, '//div/input[@class="blank"]').send_keys(answers[0])  # 填空题的答案唯一，将answers[0]输入空格
    else:
        options = browser.find_elements(By.XPATH, '//div[@class="q-answer choosable"]')      # 获取所有选择题的选项
        if(q_header=='单选题'):
            if(len(answers)!=1):               # 特殊情况，单选题中的答案不唯一，那需要将答案由空格拼接为一个字符串
                answer = ' '.join(answers)
            else:
                answer = answers[0]            # 单选题答案唯一时，将answer作为字符串变量
            for option in options:
                option_text = option.text.split('.')[1].strip()   # 选项中有开头 “A.”需要将其去掉，并将两侧空格清除，才能与答案匹配
                if(option_text==answer):
                    browser.execute_script("(arguments[0]).click()",option) # 此处为使用JavaScript语句，单纯执行click()会出现报错
        elif(q_header=='多选题'):
            for option in options:
                option_text = option.text.split('.')[1].strip()
                if(option_text in answers):
                    browser.execute_script("(arguments[0]).click()",option)
    try:
        browser.find_element(By.XPATH, '//div[@class="action-row"]/button').click()  # 答题结束后，点击提交
    except:
        button = browser.find_element(By.XPATH, '//div[@class="action-row"]/button')
        browser.execute_script("(arguments[0]).click()",button)
```

`browser.execute_script("(arguments[0]).click()",option)`的使用是为了解决`Message: element click intercepted`报错[^note]。

在答题过程中，可能会由于视频题或者偶尔选取元素的出错而无法保证正确，当出现错误时，需要再次点击“确认”才能进入下一题。

<img src="/images/2022-3-19-学习强国积分自动化/错误答案.png" width="600" height="250"/>

```
try:
    browser.find_element(By.XPATH, '//div[@class="explain"]/div')    # 若出现该节点，则表示作答错误
    browser.find_element(By.XPATH, '//div[@class="action-row"]/button').click()
except:
    pass
```

虽然无法保证百分百正确，但可以满足大多数情况的每日答题。

[^1]:[百度百科介绍](https://baike.baidu.com/item/%E5%AD%A6%E4%B9%A0%E5%BC%BA%E5%9B%BD/23230796?fr=aladdin)
[^note]:[python selenium 浏览器自动化遇到 Message: element click intercepted:解决办法（非延迟加载）](https://blog.csdn.net/u012874140/article/details/108869803)
